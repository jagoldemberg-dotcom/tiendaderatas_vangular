<main class="container py-4" *ngIf="usuario; else sinUsuario">
  <h1 class="h4 mb-3">Mi perfil</h1>

  <div class="card mb-3">
    <div class="card-body">
      <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()" novalidate>
        <div class="row g-3">
          <!-- Nombre -->
          <div class="col-12 col-md-6">
            <label class="form-label" for="nombre">Nombre</label>
            <input
              id="nombre"
              type="text"
              class="form-control"
              formControlName="nombre"
            />
            <div
              class="text-danger mt-1"
              *ngIf="f['nombre'].invalid && (f['nombre'].touched || enviado)"
            >
              El nombre es obligatorio y debe tener al menos 3 caracteres.
            </div>
          </div>

          <!-- Email (Angular lo deshabilita desde el FormGroup en TS) -->
          <div class="col-12 col-md-6">
            <label class="form-label" for="email">Correo electrónico</label>
            <input
              id="email"
              type="email"
              class="form-control"
              formControlName="email"
            />
            <div class="form-text">El correo no se puede modificar.</div>
          </div>

          <!-- Edad -->
          <div class="col-12 col-md-6">
            <label class="form-label" for="edad">Edad</label>
            <input
              id="edad"
              type="number"
              class="form-control"
              formControlName="edad"
            />
            <div
              class="text-danger mt-1"
              *ngIf="f['edad'].invalid && (f['edad'].touched || enviado)"
            >
              Debes tener al menos 13 años.
            </div>
          </div>

          <!-- Dirección -->
          <div class="col-12 col-md-6">
            <label class="form-label" for="direccion">
              Dirección de despacho
            </label>
            <input
              id="direccion"
              type="text"
              class="form-control"
              formControlName="direccion"
              placeholder="Opcional"
            />
          </div>
        </div>

        <hr class="my-4" />

        <h2 class="h6 mb-3">Cambiar contraseña</h2>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label" for="passwordActual"
              >Contraseña actual</label
            >
            <input
              id="passwordActual"
              type="password"
              class="form-control"
              formControlName="passwordActual"
              autocomplete="current-password"
            />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label" for="passwordNueva"
              >Nueva contraseña</label
            >
            <input
              id="passwordNueva"
              type="password"
              class="form-control"
              formControlName="passwordNueva"
              autocomplete="new-password"
            />
            <div class="form-text">
              Debe tener 6–18 caracteres, al menos una mayúscula y un número.
            </div>
            <div
              class="text-danger mt-1"
              *ngIf="
                f['passwordNueva'].errors?.['pattern'] &&
                (f['passwordNueva'].touched || enviado)
              "
            >
              La nueva contraseña no cumple con los requisitos de seguridad.
            </div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label" for="passwordNuevaConfirmacion"
              >Repetir nueva contraseña</label
            >
            <input
              id="passwordNuevaConfirmacion"
              type="password"
              class="form-control"
              formControlName="passwordNuevaConfirmacion"
              autocomplete="new-password"
            />
          </div>
        </div>

        <div
          class="text-danger mt-2"
          *ngIf="
            perfilForm.errors?.['passwordsNoCoinciden'] &&
            (f['passwordNuevaConfirmacion'].touched || enviado)
          "
        >
          Las nuevas contraseñas no coinciden.
        </div>

        <div
          *ngIf="mensajeErrorPassword"
          class="alert alert-danger mt-3"
        >
          {{ mensajeErrorPassword }}
        </div>

        <div class="mt-3 d-flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">
            Guardar cambios
          </button>

          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="perfilForm.reset({
              nombre: usuario.nombre,
              email: usuario.email,
              edad: usuario.edad,
              direccion: usuario.direccion || '',
              passwordActual: '',
              passwordNueva: '',
              passwordNuevaConfirmacion: ''
            })"
          >
            Deshacer cambios
          </button>

          <button
            class="btn btn-outline-danger ms-auto"
            type="button"
            (click)="cerrarSesion()"
          >
            Cerrar sesión
          </button>
        </div>

        <div *ngIf="mensajeExito" class="alert alert-success mt-3">
          {{ mensajeExito }}
        </div>
      </form>
    </div>
  </div>

  <a routerLink="/orders" class="btn btn-outline-primary">
    Ver mis compras
  </a>
</main>

<ng-template #sinUsuario>
  <div class="container py-4">
    <p>Debes iniciar sesión para ver tu perfil.</p>
    <a routerLink="/login" class="btn btn-primary">Ir a iniciar sesión</a>
  </div>
</ng-template>
